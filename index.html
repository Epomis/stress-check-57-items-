<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ストレスチェック | Modern UI</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /*
         * AppleのUI/UX原則に基づいたデザイントークン
         * - カラー: ニュートラルな背景に、明確なアクセントカラーを配置
         * - フォント: システムフォントを優先し、可読性の高いNoto Sans JPをフォールバックに指定
         * - アニメーション: ユーザーインタラクションに即時フィードバックを与えるためのスムーズなトランジション
         */
        :root {
            --background-light: #f5f5f7;
            --background-elevated: #ffffff;
            --text-primary: #1d1d1f;
            --text-secondary: #6e6e73;
            --text-tertiary: #86868b;
            --fill-tertiary: #e8e8ea;
            --separator-color: #d2d2d7;
            --blue-accent: #007aff;
            --blue-accent-hover: #0071e3;
            --red-accent: #ff3b30;
            --green-accent: #34c759;
            --orange-accent: #ff9500;
        }

        body {
            font-family: 'Inter', 'Noto Sans JP', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--background-light);
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* カスタムラジオボタン（セグメンテッドコントロール風） */
        .segmented-control input[type="radio"] {
            display: none;
        }
        .segmented-control-label {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1.5px solid transparent;
        }
        .segmented-control input[type="radio"]:checked + .segmented-control-label {
            background-color: var(--background-elevated);
            color: var(--blue-accent);
            border-color: var(--blue-accent);
            box-shadow: 0 2px 8px -1px rgba(0, 122, 255, 0.2);
            transform: translateY(-1px);
        }

        /* 質問未回答時のハイライト */
        .unanswered-question {
            background-color: rgba(255, 59, 48, 0.05);
            border: 1.5px solid var(--red-accent);
            border-radius: 1rem; /* 16px */
            box-shadow: 0 0 12px rgba(255, 59, 48, 0.3);
            transition: all 0.3s ease-in-out;
        }
        
        /* 結果カードのアニメーション */
        .result-card {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }
        .result-card.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* ボタンのローディングインジケーター */
        .loader {
            width: 20px;
            height: 20px;
            border: 2px solid #FFF;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased">

    <!-- ヘッダー -->
    <header class="bg-white/80 backdrop-blur-xl sticky top-0 z-40 border-b border-[var(--separator-color)]">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16 md:h-20">
                <div class="flex items-center space-x-2">
                     <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-[var(--blue-accent)]"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"></path></svg>
                    <h1 class="text-xl md:text-2xl font-bold text-slate-900">ストレスチェック</h1>
                </div>
                <a href="https://workplace-healthcare.com/" target="_blank" rel="noopener noreferrer" class="text-sm font-medium text-[var(--text-secondary)] hover:text-[var(--blue-accent)] transition-colors">
                    提供: D2C産業医
                </a>
            </div>
        </div>
    </header>

    <!-- メインコンテンツ -->
    <main class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
        <div class="space-y-10">
            <!-- 導入セクション -->
            <section id="introduction" class="bg-[var(--background-elevated)] p-6 sm:p-8 rounded-2xl shadow-sm">
                <div class="mb-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-1">はじめに</h2>
                    <p class="text-sm text-[var(--text-secondary)]">より正確な結果を得るために、性別を選択し、各質問に正直にお答えください。</p>
                </div>
                <div id="gender-selection" class="p-1.5 rounded-xl bg-[var(--fill-tertiary)]">
                    <div class="segmented-control grid grid-cols-2 gap-1.5">
                        <label class="flex-1 text-center">
                            <input type="radio" name="gender" value="male" required>
                            <div class="segmented-control-label cursor-pointer py-2.5 px-4 rounded-lg text-[var(--text-primary)] font-semibold text-sm">男性</div>
                        </label>
                        <label class="flex-1 text-center">
                            <input type="radio" name="gender" value="female" required>
                            <div class="segmented-control-label cursor-pointer py-2.5 px-4 rounded-lg text-[var(--text-primary)] font-semibold text-sm">女性</div>
                        </label>
                    </div>
                </div>
            </section>

            <!-- 質問フォーム -->
            <form id="stress-check-form" class="space-y-10">
                <!-- JavaScriptによって質問がここに挿入されます -->
            </form>

            <!-- 操作ボタン -->
            <div class="mt-12 text-center">
                <button id="calculate-btn" type="button" class="w-full sm:w-auto bg-[var(--blue-accent)] hover:bg-[var(--blue-accent-hover)] text-white font-bold text-lg py-4 px-16 rounded-xl shadow-lg shadow-blue-500/20 transition-all duration-300 ease-in-out focus:outline-none focus:ring-4 focus:ring-blue-300 transform hover:scale-105">
                    <span id="btn-text">結果を診断する</span>
                    <span id="btn-loader" class="hidden loader"></span>
                </button>
            </div>

            <!-- 結果表示エリア -->
            <div id="results-container" class="mt-12">
                <!-- JavaScriptによって結果がここに挿入されます -->
            </div>
        </div>
    </main>
    
    <!-- フッター -->
    <footer class="mt-16 pb-12">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-xs text-[var(--text-tertiary)]">
            <p>このストレスチェックは、医学的診断に代わるものではありません。結果について不安な点があれば、専門の医師にご相談ください。</p>
            <p class="mt-3">
                <a href="https://workplace-healthcare.com/" target="_blank" rel="noopener noreferrer" class="font-medium hover:underline text-[var(--text-secondary)]">D2C産業医 &copy; 2024</a>
            </p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA: Questions ---
            const questions = [
                // A
                { id: 'A1', section: 'A', text: '1. 非常にたくさんの仕事をしなければならない' }, { id: 'A2', section: 'A', text: '2. 時間内に仕事が処理しきれない' }, { id: 'A3', section: 'A', text: '3. 一生懸命働かなければならない' }, { id: 'A4', section: 'A', text: '4. かなり注意を集中する必要がある' }, { id: 'A5', section: 'A', text: '5. 高度の知識や技術が必要なむずかしい仕事だ' }, { id: 'A6', section: 'A', text: '6. 勤務時間中はいつも仕事のことを考えていなければならない' }, { id: 'A7', section: 'A', text: '7. からだを大変よく使う仕事だ' }, { id: 'A8', section: 'A', text: '8. 自分のペースで仕事ができる' }, { id: 'A9', section: 'A', text: '9. 自分で仕事の順番・やり方を決めることができる' }, { id: 'A10', section: 'A', text: '10. 職場の仕事の方針に自分の意見を反映できる' }, { id: 'A11', section: 'A', text: '11. 自分の技能や知識を仕事で使うことが少ない' }, { id: 'A12', section: 'A', text: '12. 私の部署内で意見のくい違いがある' }, { id: 'A13', section: 'A', text: '13. 私の部署と他の部署とはうまが合わない' }, { id: 'A14', section: 'A', text: '14. 私の職場の雰囲気は友好的である' }, { id: 'A15', section: 'A', text: '15. 私の職場の作業環境（騒音、照明、温度、換気など）はよくない' }, { id: 'A16', section: 'A', text: '16. 仕事の内容は自分にあっている' }, { id: 'A17', section: 'A', text: '17. 働きがいのある仕事だ' },
                // B
                { id: 'B1', section: 'B', text: '1. 活気がわいてくる' }, { id: 'B2', section: 'B', text: '2. 元気がいっぱいだ' }, { id: 'B3', section: 'B', text: '3. 生き生きする' }, { id: 'B4', section: 'B', text: '4. 怒りを感じる' }, { id: 'B5', section: 'B', text: '5. 内心腹立たしい' }, { id: 'B6', section: 'B', text: '6. イライラしている' }, { id: 'B7', section: 'B', text: '7. ひどく疲れた' }, { id: 'B8', section: 'B', text: '8. へとへとだ' }, { id: 'B9', section: 'B', text: '9. だるい' }, { id: 'B10', section: 'B', text: '10. 気がはりつめている' }, { id: 'B11', section: 'B', text: '11. 不安だ' }, { id: 'B12', section: 'B', text: '12. 落着かない' }, { id: 'B13', section: 'B', text: '13. ゆううつだ' }, { id: 'B14', section: 'B', text: '14. 何をするのも面倒だ' }, { id: 'B15', section: 'B', text: '15. 物事に集中できない' }, { id: 'B16', section: 'B', text: '16. 気分が晴れない' }, { id: 'B17', section: 'B', text: '17. 仕事が手につかない' }, { id: 'B18', section: 'B', text: '18. 悲しいと感じる' }, { id: 'B19', section: 'B', text: '19. めまいがする' }, { id: 'B20', section: 'B', text: '20. 体のふしぶしが痛む' }, { id: 'B21', section: 'B', text: '21. 頭が重かったり頭痛がする' }, { id: 'B22', section: 'B', text: '22. 首筋や肩がこる' }, { id: 'B23', section: 'B', text: '23. 腰が痛い' }, { id: 'B24', section: 'B', text: '24. 目が疲れる' }, { id: 'B25', section: 'B', text: '25. 動悸や息切れがする' }, { id: 'B26', section: 'B', text: '26. 胃腸の具合が悪い' }, { id: 'B27', section: 'B', text: '27. 食欲がない' }, { id: 'B28', section: 'B', text: '28. 便秘や下痢をする' }, { id: 'B29', section: 'B', text: '29. よく眠れない' },
                // C
                { id: 'C1', section: 'C', text: '1. 上司', header: '次の人たちはどのくらい気軽に話ができますか？' }, { id: 'C2', section: 'C', text: '2. 職場の同僚' }, { id: 'C3', section: 'C', text: '3. 配偶者、家族、友人等' }, { id: 'C4', section: 'C', text: '4. 上司', header: 'あなたが困った時、次の人たちはどのくらい頼りになりますか？' }, { id: 'C5', section: 'C', text: '5. 職場の同僚' }, { id: 'C6', section: 'C', text: '6. 配偶者、家族、友人等' }, { id: 'C7', section: 'C', text: '7. 上司', header: 'あなたの個人的な問題を相談したら、次の人たちはどのくらいきいてくれますか？' }, { id: 'C8', section: 'C', text: '8. 職場の同僚' }, { id: 'C9', section: 'C', text: '9. 配偶者、家族、友人等' },
                // D
                { id: 'D1', section: 'D', text: '1. 仕事に満足だ' }, { id: 'D2', section: 'D', text: '2. 家庭生活に満足だ' },
            ];

            const answerOptions = {
                A: [{ text: 'そうだ', value: 1 }, { text: 'まあそうだ', value: 2 }, { text: 'ややちがう', value: 3 }, { text: 'ちがう', value: 4 }],
                B: [{ text: 'そうだ', value: 1 }, { text: 'まあそうだ', value: 2 }, { text: 'ややちがう', value: 3 }, { text: 'ちがう', value: 4 }],
                C: [{ text: '非常に', value: 1 }, { text: 'かなり', value: 2 }, { text: '多少', value: 3 }, { text: '全くない', value: 4 }],
                D: [{ text: '満足', value: 1 }, { text: 'まあ満足', value: 2 }, { text: 'やや不満', value: 3 }, { text: '不満', value: 4 }]
            };

            const form = document.getElementById('stress-check-form');

            // --- UI Rendering ---
            function renderQuestions() {
                const sections = { A: [], B: [], C: [], D: [] };
                const sectionInfo = {
                    A: { title: 'あなたの仕事について', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><rect width="16" height="20" x="4" y="2" rx="2" /><path d="M9 22v-4h6v4" /><path d="M8 6h.01" /><path d="M16 6h.01" /><path d="M12 6h.01" /><path d="M12 10h.01" /><path d="M12 14h.01" /><path d="M16 10h.01" /><path d="M8 10h.01" /><path d="M8 14h.01" /><path d="M16 14h.01" /></svg>` },
                    B: { title: '最近1か月のあなたの状態について', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M12 2a10 10 0 1 0 10 10H12V2z" /><path d="M12 12a10 10 0 0 0-10 10h10V12z" /></svg>` },
                    C: { title: 'あなたの周りの方々について', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M22 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /></svg>` },
                    D: { title: '満足度について', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><circle cx="12" cy="12" r="10" /><path d="M8 14s1.5 2 4 2 4-2 4-2" /><line x1="9" x2="9.01" y1="9" y2="9" /><line x1="15" x2="15.01" y1="9" y2="9" /></svg>` }
                };

                questions.forEach(q => sections[q.section].push(q));

                for (const key in sections) {
                    const sectionCard = document.createElement('section');
                    sectionCard.className = 'bg-[var(--background-elevated)] p-6 sm:p-8 rounded-2xl shadow-sm';
                    
                    const titleDiv = document.createElement('div');
                    titleDiv.className = 'flex items-center space-x-3 text-[var(--blue-accent)] mb-6';
                    titleDiv.innerHTML = sectionInfo[key].icon;
                    const title = document.createElement('h3');
                    title.className = 'text-xl font-bold text-gray-900';
                    title.textContent = sectionInfo[key].title;
                    titleDiv.appendChild(title);
                    sectionCard.appendChild(titleDiv);

                    let questionCounter = 0;
                    sections[key].forEach(q => {
                        if (q.header) {
                            const subHeader = document.createElement('p');
                            subHeader.className = 'text-md font-semibold text-gray-800 mt-10 mb-4 pt-6 border-t border-[var(--separator-color)]';
                            subHeader.textContent = q.header;
                            sectionCard.appendChild(subHeader);
                        }

                        const questionDiv = document.createElement('div');
                        questionDiv.id = `q-container-${q.id}`;
                        questionDiv.className = 'py-5';
                        if(questionCounter > 0) questionDiv.classList.add('border-t', 'border-gray-100');

                        const label = document.createElement('label');
                        label.className = 'block text-md font-medium text-gray-800 mb-4';
                        label.textContent = q.text;
                        questionDiv.appendChild(label);

                        const optionsDiv = document.createElement('div');
                        optionsDiv.className = 'grid grid-cols-2 sm:grid-cols-4 gap-2 sm:gap-3';
                        const currentOptions = answerOptions[q.section];

                        currentOptions.forEach(opt => {
                             const optionLabel = document.createElement('label');
                             optionLabel.className = "block";
                             const radio = document.createElement('input');
                             radio.type = 'radio';
                             radio.name = q.id;
                             radio.value = opt.value;
                             radio.required = true;
                             radio.className = "sr-only";
                             
                             const span = document.createElement('div');
                             span.className = 'cursor-pointer text-center py-3 px-2 rounded-lg text-sm font-medium border border-gray-200 bg-white text-gray-700 hover:bg-gray-50 transition-all duration-200';
                             span.textContent = opt.text;
                             
                             // FIX: Explicitly manage classes to prevent UI bugs
                             radio.addEventListener('change', () => {
                                document.querySelectorAll(`input[name="${q.id}"]`).forEach(r => {
                                    const s = r.nextElementSibling;
                                    if (r.checked) {
                                        s.classList.remove('bg-white', 'text-gray-700');
                                        s.classList.add('bg-[var(--blue-accent)]', 'text-white', 'border-[var(--blue-accent)]');
                                    } else {
                                        s.classList.remove('bg-[var(--blue-accent)]', 'text-white', 'border-[var(--blue-accent)]');
                                        s.classList.add('bg-white', 'text-gray-700');
                                    }
                                });
                             });

                             optionLabel.appendChild(radio);
                             optionLabel.appendChild(span);
                             optionsDiv.appendChild(optionLabel);
                        });
                        questionDiv.appendChild(optionsDiv);
                        sectionCard.appendChild(questionDiv);
                        questionCounter++;
                    });
                    form.appendChild(sectionCard);
                }
            }

            // --- Calculation Logic ---
            // FIX: Renamed function for clarity. It converts raw score to a 5-level evaluation.
            function convertTo5LevelEval(scaleName, rawScore, gender) {
                // This function converts a raw score to a 5-level evaluation (1-5),
                // where 1 is high stress and 5 is low stress, based on the provided conversion table.
                const tables = {
                    male: {
                        '心理的な仕事の負担(量)': (v) => { if (v <= 5) return 5; if (v <= 7) return 4; if (v <= 9) return 3; if (v <= 11) return 2; return 1; },
                        '心理的な仕事の負担(質)': (v) => { if (v <= 5) return 5; if (v <= 7) return 4; if (v <= 9) return 3; if (v <= 11) return 2; return 1; },
                        '自覚的な身体的負担度': (v) => { if (v === 1) return 5; if (v === 2) return 3; if (v === 3) return 2; if (v === 4) return 1; return 0; },
                        '職場の対人関係でのストレス': (v) => { if (v <= 3) return 5; if (v <= 5) return 4; if (v <= 7) return 3; if (v <= 9) return 2; return 1; },
                        '職場環境によるストレス': (v) => { if (v === 1) return 4; if (v === 2) return 3; if (v === 3) return 2; if (v === 4) return 1; return 0; },
                        '仕事のコントロール度': (v) => { if (v <= 4) return 1; if (v <= 6) return 2; if (v <= 8) return 3; if (v <= 10) return 4; return 5; },
                        '技能の活用度': (v) => { if (v === 1) return 1; if (v === 2) return 2; if (v === 3) return 4; if (v === 4) return 5; return 0; },
                        '仕事の適性度': (v) => { if (v === 1) return 1; if (v === 2) return 2; if (v === 3) return 3; if (v === 4) return 5; return 0; },
                        '働きがい': (v) => { if (v === 1) return 1; if (v === 2) return 2; if (v === 3) return 3; if (v === 4) return 5; return 0; },
                        '活気': (v) => { if (v <= 3) return 1; if (v <= 5) return 2; if (v <= 7) return 3; if (v <= 9) return 4; return 5; },
                        'イライラ感': (v) => { if (v <= 3) return 5; if (v <= 5) return 4; if (v <= 7) return 3; if (v <= 9) return 2; return 1; },
                        '疲労感': (v) => { if (v <= 3) return 5; if (v <= 4) return 4; if (v <= 7) return 3; if (v <= 10) return 2; return 1; },
                        '不安感': (v) => { if (v <= 3) return 5; if (v <= 4) return 4; if (v <= 7) return 3; if (v <= 9) return 2; return 1; },
                        '抑うつ感': (v) => { if (v <= 6) return 5; if (v <= 8) return 4; if (v <= 12) return 3; if (v <= 16) return 2; return 1; },
                        '身体愁訴': (v) => { if (v <= 11) return 5; if (v <= 15) return 4; if (v <= 21) return 3; if (v <= 26) return 2; return 1; },
                        '上司からのサポート': (v) => { if (v <= 4) return 1; if (v <= 6) return 2; if (v <= 8) return 3; if (v <= 10) return 4; return 5; },
                        '同僚からのサポート': (v) => { if (v <= 5) return 1; if (v <= 7) return 2; if (v <= 9) return 3; if (v <= 11) return 4; return 5; },
                        '家族・友人からのサポート': (v) => { if (v <= 6) return 1; if (v <= 8) return 2; if (v === 9) return 3; if (v <= 11) return 4; return 5; },
                        '仕事や生活の満足度': (v) => { if (v <= 3) return 1; if (v === 4) return 2; if (v <= 6) return 3; if (v === 7) return 4; return 5; }
                    },
                    female: {
                        '心理的な仕事の負担(量)': (v) => { if (v <= 4) return 5; if (v <= 6) return 4; if (v <= 9) return 3; if (v <= 11) return 2; return 1; },
                        '心理的な仕事の負担(質)': (v) => { if (v <= 4) return 5; if (v <= 6) return 4; if (v <= 8) return 3; if (v <= 10) return 2; return 1; },
                        '自覚的な身体的負担度': (v) => { if (v === 1) return 5; if (v === 2) return 3; if (v === 3) return 2; if (v === 4) return 1; return 0; },
                        '職場の対人関係でのストレス': (v) => { if (v <= 3) return 5; if (v <= 5) return 4; if (v <= 7) return 3; if (v <= 9) return 2; return 1; },
                        '職場環境によるストレス': (v) => { if (v === 1) return 4; if (v === 2) return 3; if (v === 3) return 2; if (v === 4) return 1; return 0; },
                        '仕事のコントロール度': (v) => { if (v <= 3) return 1; if (v <= 5) return 2; if (v <= 8) return 3; if (v <= 10) return 4; return 5; },
                        '技能の活用度': (v) => { if (v === 1) return 1; if (v === 2) return 2; if (v === 3) return 4; if (v === 4) return 5; return 0; },
                        '仕事の適性度': (v) => { if (v === 1) return 1; if (v === 2) return 2; if (v === 3) return 3; if (v === 4) return 5; return 0; },
                        '働きがい': (v) => { if (v === 1) return 1; if (v === 2) return 2; if (v === 3) return 3; if (v === 4) return 5; return 0; },
                        '活気': (v) => { if (v <= 3) return 1; if (v <= 5) return 2; if (v <= 7) return 3; if (v <= 9) return 4; return 5; },
                        'イライラ感': (v) => { if (v <= 3) return 5; if (v <= 5) return 4; if (v <= 8) return 3; if (v <= 10) return 2; return 1; },
                        '疲労感': (v) => { if (v <= 3) return 5; if (v <= 5) return 4; if (v <= 8) return 3; if (v <= 11) return 2; return 1; },
                        '不安感': (v) => { if (v <= 3) return 5; if (v <= 4) return 4; if (v <= 7) return 3; if (v <= 10) return 2; return 1; },
                        '抑うつ感': (v) => { if (v <= 6) return 5; if (v <= 8) return 4; if (v <= 12) return 3; if (v <= 17) return 2; return 1; },
                        '身体愁訴': (v) => { if (v <= 13) return 5; if (v <= 17) return 4; if (v <= 23) return 3; if (v <= 29) return 2; return 1; },
                        '上司からのサポート': (v) => { if (v <= 3) return 1; if (v <= 5) return 2; if (v <= 7) return 3; if (v <= 10) return 4; return 5; },
                        '同僚からのサポート': (v) => { if (v <= 5) return 1; if (v <= 7) return 2; if (v <= 9) return 3; if (v <= 11) return 4; return 5; },
                        '家族・友人からのサポート': (v) => { if (v <= 6) return 1; if (v <= 8) return 2; if (v === 9) return 3; if (v <= 11) return 4; return 5; },
                        '仕事や生活の満足度': (v) => { if (v <= 3) return 1; if (v === 4) return 2; if (v <= 6) return 3; if (v === 7) return 4; return 5; }
                    }
                };
                return tables[gender]?.[scaleName]?.(rawScore) ?? 0;
            }

            function calculateScores() {
                document.querySelectorAll('.unanswered-question').forEach(el => el.classList.remove('unanswered-question'));
                
                const gender = document.querySelector('input[name="gender"]:checked')?.value;
                if (!gender) {
                    showModal('性別を選択してください。', '未選択の項目があります');
                    const genderEl = document.getElementById('gender-selection');
                    genderEl.classList.add('unanswered-question');
                    genderEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    return null;
                } else {
                    document.getElementById('gender-selection').classList.remove('unanswered-question');
                }

                const answers = {};
                const formData = new FormData(form);
                let firstUnanswered = null;

                for (const q of questions) {
                    const value = formData.get(q.id);
                    if (value) {
                        answers[q.id] = parseInt(value);
                    } else {
                        if (!firstUnanswered) firstUnanswered = q.id;
                    }
                }

                if (firstUnanswered) {
                    const el = document.getElementById(`q-container-${firstUnanswered}`);
                    if (el) {
                        el.classList.add('unanswered-question');
                        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                    showModal('すべての質問に回答してください。未回答の質問がハイライトされています。', '入力が完了していません');
                    return null;
                }
                
                const rawScores = {
                    A: { '心理的な仕事の負担(量)': 15 - (answers.A1 + answers.A2 + answers.A3), '心理的な仕事の負担(質)': 15 - (answers.A4 + answers.A5 + answers.A6), '自覚的な身体的負担度': 5 - answers.A7, '職場の対人関係でのストレス': 10 - (answers.A12 + answers.A13) + answers.A14, '職場環境によるストレス': 5 - answers.A15, '仕事のコントロール度': 15 - (answers.A8 + answers.A9 + answers.A10), '技能の活用度': answers.A11, '仕事の適性度': 5 - answers.A16, '働きがい': 5 - answers.A17, },
                    B: { '活気': 15 - (answers.B1 + answers.B2 + answers.B3), 'イライラ感': 15 - (answers.B4 + answers.B5 + answers.B6), '疲労感': 15 - (answers.B7 + answers.B8 + answers.B9), '不安感': 15 - (answers.B10 + answers.B11 + answers.B12), '抑うつ感': 30 - [answers.B13, answers.B14, answers.B15, answers.B16, answers.B17, answers.B18].reduce((a, b) => a + b, 0), '身体愁訴': 55 - [answers.B19, answers.B20, answers.B21, answers.B22, answers.B23, answers.B24, answers.B25, answers.B26, answers.B27, answers.B28, answers.B29].reduce((a, b) => a + b, 0), },
                    C: { '上司からのサポート': 15 - (answers.C1 + answers.C4 + answers.C7), '同僚からのサポート': 15 - (answers.C2 + answers.C5 + answers.C8), '家族・友人からのサポート': 15 - (answers.C3 + answers.C6 + answers.C9), },
                    D: { '仕事や生活の満足度': 10 - (answers.D1 + answers.D2) }
                };
                
                const fiveLevelEvals = { A: {}, B: {}, C: {}, D: {} };
                const fiveLevelTotals = { A: 0, B: 0, C: 0 };

                for (const section in rawScores) {
                    for (const scaleName in rawScores[section]) {
                        const rawScore = rawScores[section][scaleName];
                        const fiveLevel = convertTo5LevelEval(scaleName, rawScore, gender);
                        fiveLevelEvals[section][scaleName] = fiveLevel;
                        if (fiveLevelTotals.hasOwnProperty(section)) {
                            fiveLevelTotals[section] += fiveLevel;
                        }
                    }
                }
                
                const totalB = fiveLevelTotals.B;
                const totalAC = fiveLevelTotals.A + fiveLevelTotals.C;
                
                let isHighStress = (totalB <= 12) || (totalAC <= 26 && totalB <= 17);
                let reason = isHighStress ? 
                    (totalB <= 12 ? `心身のストレス反応（領域B）の5段階評価合計が ${totalB} であり、基準（12以下）に該当しました。` : `仕事のストレス要因（領域A）と周囲のサポート（領域C）の5段階評価合計が ${totalAC}（基準26以下）、かつ心身のストレス反応（領域B）の5段階評価合計が ${totalB}（基準17以下）であり、基準に該当しました。`) : 
                    '総合的な評価の結果、高ストレス者には該当しませんでした。';
                
                return { fiveLevelTotals, fiveLevelEvals, isHighStress, reason, gender };
            }

            // --- 結果表示 (UI/UX 改善) ---
            function displayResults(results) {
                if (!results) return;

                const { fiveLevelTotals, fiveLevelEvals, isHighStress, reason, gender } = results;
                const container = document.getElementById('results-container');
                container.innerHTML = ''; // 結果をクリア

                const resultColor = isHighStress ? 'var(--red-accent)' : 'var(--green-accent)';
                const resultBgColor = isHighStress ? 'rgba(255, 59, 48, 0.1)' : 'rgba(52, 199, 89, 0.1)';
                const genderText = gender === 'male' ? '男性' : '女性';

                let highStressGuidance = '';
                if (isHighStress) {
                    highStressGuidance = `
                        <div class="bg-orange-50 border-l-4 border-[var(--orange-accent)] p-5 mt-6 rounded-r-lg">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <svg class="h-6 w-6 text-[var(--orange-accent)]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                                    </svg>
                                </div>
                                <div class="ml-4">
                                    <p class="font-bold text-orange-800">専門家への相談を推奨します</p>
                                    <p class="text-sm text-orange-700 mt-1">
                                        ストレスが高い状態が続くと心身に不調をきたす可能性があります。一人で抱え込まず、専門の医師やカウンセラーに相談することをご検討ください。
                                    </p>
                                    <a href="https://workplace-healthcare.com/" target="_blank" rel="noopener noreferrer" class="inline-block mt-4 bg-[var(--orange-accent)] text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-500 transition-colors text-sm">
                                        D2C産業医に相談する
                                    </a>
                                </div>
                            </div>
                        </div>
                    `;
                }

                const resultCard = document.createElement('div');
                resultCard.className = 'bg-[var(--background-elevated)] p-6 sm:p-8 rounded-2xl shadow-sm result-card';
                resultCard.innerHTML = `
                    <h2 class="text-2xl font-bold text-center mb-2">診断結果</h2>
                    <p class="text-center text-sm text-[var(--text-secondary)] mb-8">(${genderText}の基準で評価)</p>
                    
                    <div class="text-center p-5 rounded-xl" style="background-color: ${resultBgColor};">
                        <p class="text-xl font-bold" style="color: ${resultColor};">${isHighStress ? '「高ストレス者」と判定されました' : '「高ストレス者」には該当しませんでした'}</p>
                        <p class="text-sm text-[var(--text-secondary)] mt-2">${reason}</p>
                    </div>
                    ${highStressGuidance}

                    <div class="mt-8 space-y-4">
                        <h3 class="text-lg font-semibold text-gray-900 text-center">領域別評価合計</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
                            <div class="bg-[var(--background-light)] p-4 rounded-xl">
                                <p class="text-sm text-[var(--text-secondary)]">仕事のストレス要因 (A)</p>
                                <p class="text-3xl font-bold text-[var(--text-primary)]">${fiveLevelTotals.A}</p>
                            </div>
                            <div class="bg-[var(--background-light)] p-4 rounded-xl">
                                <p class="text-sm text-[var(--text-secondary)]">心身のストレス反応 (B)</p>
                                <p class="text-3xl font-bold text-[var(--text-primary)]">${fiveLevelTotals.B}</p>
                            </div>
                            <div class="bg-[var(--background-light)] p-4 rounded-xl">
                                <p class="text-sm text-[var(--text-secondary)]">周囲のサポート (C)</p>
                                <p class="text-3xl font-bold text-[var(--text-primary)]">${fiveLevelTotals.C}</p>
                            </div>
                        </div>
                    </div>
                    
                    <details class="mt-8 bg-[var(--background-light)] rounded-xl group">
                        <summary class="flex items-center justify-between font-medium text-gray-800 p-4 cursor-pointer">
                            <span>全ての尺度の5段階評価</span>
                            <svg class="w-5 h-5 transition-transform duration-300 group-open:rotate-180" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
                        </summary>
                        <div class="border-t border-[var(--separator-color)] p-4 space-y-6">
                            ${Object.entries({A: '領域A: 仕事のストレス要因', B: '領域B: 心身のストレス反応', C: '領域C: 周囲のサポート', D: '参考'}).map(([section, title]) => `
                                <div>
                                    <h4 class="font-bold text-md text-gray-800 mb-3">${title}</h4>
                                    <ul class="space-y-2 text-sm text-[var(--text-secondary)]">
                                        ${Object.entries(fiveLevelEvals[section]).map(([scaleName, fiveLevel]) => `
                                            <li class="flex justify-between items-center">
                                                <span>${scaleName}</span>
                                                <span class="font-semibold text-[var(--text-primary)] bg-white px-3 py-1 rounded-md text-sm">${fiveLevel}</span>
                                            </li>
                                        `).join('')}
                                    </ul>
                                </div>
                            `).join('')}
                        </div>
                    </details>
                `;
                
                container.appendChild(resultCard);
                // 遅延させて表示アニメーションを発火
                setTimeout(() => {
                    resultCard.classList.add('visible');
                    resultCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            }

            // --- モーダル表示 (UI/UX 改善) ---
            function showModal(message, title = 'ご注意') {
                let modal = document.getElementById('alert-modal');
                if (modal) modal.remove();
                
                modal = document.createElement('div');
                modal.id = 'alert-modal';
                modal.className = 'fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50 px-4 transition-opacity duration-300';
                modal.innerHTML = `
                    <div class="p-6 w-full max-w-sm shadow-2xl rounded-2xl bg-white/90 backdrop-blur-xl transform scale-95 transition-all duration-300">
                        <div class="text-center">
                            <h3 class="text-lg font-bold text-gray-900">${title}</h3>
                            <p class="text-sm text-gray-600 mt-2 mb-6">${message}</p>
                            <button id="close-modal-btn" class="w-full px-4 py-2.5 bg-[var(--blue-accent)] text-white text-base font-medium rounded-lg hover:bg-[var(--blue-accent-hover)] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                                閉じる
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                const modalContent = modal.querySelector('div > div');
                
                // 表示アニメーション
                setTimeout(() => {
                    modal.classList.add('opacity-100');
                    modalContent.classList.remove('scale-95');
                }, 10);

                const closeModal = () => {
                    modal.classList.remove('opacity-100');
                    modalContent.classList.add('scale-95');
                    setTimeout(() => modal.remove(), 300);
                };

                modal.addEventListener('click', (e) => {
                    if (e.target.id === 'alert-modal') closeModal();
                });
                document.getElementById('close-modal-btn').addEventListener('click', closeModal);
            }

            // --- Event Listeners ---
            const calculateBtn = document.getElementById('calculate-btn');
            const btnText = document.getElementById('btn-text');
            const btnLoader = document.getElementById('btn-loader');

            calculateBtn.addEventListener('click', () => {
                // ローディング表示を開始
                btnText.classList.add('hidden');
                btnLoader.classList.remove('hidden');
                calculateBtn.disabled = true;

                // 計算処理を非同期に実行してUIのフリーズを防ぐ
                setTimeout(() => {
                    try {
                        const results = calculateScores();
                        if (results) {
                            displayResults(results);
                        }
                    } catch (error) {
                        console.error("An error occurred during calculation:", error);
                        showModal("結果の計算中にエラーが発生しました。ページを再読み込みしてお試しください。", "エラー");
                    } finally {
                        // ローディング表示を終了
                        btnText.classList.remove('hidden');
                        btnLoader.classList.add('hidden');
                        calculateBtn.disabled = false;
                    }
                }, 500); // ユーザーに処理中であることを示すための意図的な遅延
            });

            // --- Initial Load ---
            renderQuestions();
        });
    </script>
</body>
</html>
